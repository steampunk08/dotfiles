#!/usr/bin/bash

# colour configurations
_NORMAL="\e[0m"
_DIR="\e[38;5;105;1m"
_FILE="\e[38;5;105m"
CLEAR="\e[0m"

function show_usage() { 
   echo "run scripts under \$ADDONS_FOLDER using patterns"
   echo "using patterns to match script names"
   echo
   echo "Usage: addon [options] [pattern]"
   echo
   echo "Options"
   echo "    -d ARG, change addon look up directory to ARG"
   echo "    -h, display this message" 
   echo 
   echo "Addon script written by Sphe M"
   exit 1
}

change_folder() {
   if [ ! -d $1 ]; then
      echo -e "${_DIR}$1${_NORMAL} doesn't exist$CLEAR"
      echo -en "${_NORMAL}Do you want to create ${_DIR}$1${_NORMAL} (Y/n)? "
      read response

      if [[ $response = "y" ]] || [[ $response = "Y" ]]; then
         mkdir $1
         echo $(realpath $1) > ~/.addon
         exit 0
      else
         exit 1
      fi
   fi
   echo $(realpath $1) > ~/.addon
}

while getopts "d:h" option; do
   case $option in
      d ) shift $((OPTIND - 1))
         ADDONS_FOLDER=$OPTARG
         change_folder $OPTARG ;;
      h ) show_usage ;;
      * ) show_usage ;;
   esac
done

if [[ -z $ADDONS_FOLDER ]]; then
   if [[ -f ~/.addon ]]; then
      ADDONS_FOLDER=$(cat ~/.addon)
      change_folder $ADDONS_FOLDER
   else
      ADDONS_FOLDER=~/addons
      change_folder $ADDONS_FOLDER
   fi
fi

AVAILABLE_ADDONS=($ADDONS_FOLDER/*.addon)

if [ -z $AVAILABLE_ADDONS ]; then
   echo -e ${_NORMAL}no ${_FILE}.addon${_NORMAL} files \
      found in ${_DIR}${ADDONS_FOLDER}$CLEAR
   exit 1
fi

[ -z $1 ] && echo "no plugin name spercified" && exit 1

for addon in ${AVAILABLE_ADDONS[*]}; do
   if [[ $addon =~ $1 ]]; then
      if [ ${#@} -eq 1 ]; then
         $addon
      else
         shift 1
         $addon $@
      fi
      exit 1
   fi
done


echo -e ${_NORMAL}addon matching ${_FILE}$1${_NORMAL} not \
   found in ${_DIR}${ADDONS_FOLDER}$CLEAR
